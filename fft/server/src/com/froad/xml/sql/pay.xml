<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="pay">
	<typeAlias alias="pay" type="com.froad.CB.po.Pay"/>
	
	<resultMap id="PayResult" class="pay">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="trans_id" property="transId" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="VARCHAR" />
		<result column="from_account_name" property="fromAccountName" jdbcType="VARCHAR" />
		<result column="from_account_no" property="fromAccountNo" jdbcType="VARCHAR" />
		<result column="pay_value" property="payValue" jdbcType="VARCHAR" />
		<result column="to_account_name" property="toAccountName" jdbcType="VARCHAR" />
		<result column="to_account_no" property="toAccountNo" jdbcType="VARCHAR" />
		<result column="state" property="state" jdbcType="VARCHAR" />
		<result column="step" property="step" jdbcType="VARCHAR" />
		<result column="result_code" property="resultCode" jdbcType="VARCHAR" />
		<result column="result_desc" property="resultDesc" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" jdbcType="VARCHAR" />
		<result column="update_time" property="updateTime" jdbcType="VARCHAR" />
		<result column="remark" property="remark" jdbcType="VARCHAR" />
		
		<result property="fromAccountType" column="from_account_type" jdbcType="VARCHAR"/>
		<result property="toAccountType" column="to_account_type" jdbcType="VARCHAR"/>
		<result property="fromPhone" column="from_phone" jdbcType="VARCHAR"/>
		<result property="toPhone" column="to_phone" jdbcType="VARCHAR"/>
		<result property="fromId" column="from_id" jdbcType="VARCHAR"/>
		<result property="toId" column="to_id" jdbcType="VARCHAR"/>
		<result property="fromUsername" column="from_username" jdbcType="VARCHAR"/>
		<result property="toUsername" column="to_username" jdbcType="VARCHAR"/>
		<result property="channelType" column="channel_type" jdbcType="VARCHAR"/>
		<result property="channelId" column="channel_id" jdbcType="VARCHAR"/>
		<result property="fundsChannel" column="channel_id" select="fundsChannel.selectByPrimaryKey"/>
		<result property="ruleType" column="rule_type" jdbcType="VARCHAR"/>
		<result property="ruleId" column="rule_id" jdbcType="VARCHAR"/>
		<result property="ruleDetailId" column="rule_detail_id" jdbcType="VARCHAR"/>
		<result property="isIntime" column="is_intime" jdbcType="VARCHAR"/>
		<result property="typeDetail" column="type_detail" jdbcType="VARCHAR"/>
		
		<result property="fromRole" column="from_role" jdbcType="VARCHAR"/>
		<result property="toRole" column="to_role" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="selectByPrimaryKey" resultMap="PayResult" parameterClass="java.lang.Integer">
		select * from pay where id = #id:INTEGER#
	</select>
	
	<select id="selectByTranId" resultMap="PayResult" parameterClass="string">
		select * from pay where trans_id=#value# order by step
	</select>
	
	<delete id="deleteByPrimaryKey" parameterClass="java.lang.Integer">
		delete from pay where id = #id:INTEGER#
	</delete>
	
	<insert id="insert" parameterClass="pay">
		insert into pay (id,from_role,to_role,
		type_detail,trans_id, type,
		from_account_name, from_account_no, pay_value, to_account_name,
		to_account_no, state, step, result_code, result_desc,
		remark,from_account_type,to_account_type,from_phone,to_phone,
		from_id,to_id,from_username,to_username,channel_type,
		channel_id,rule_type,rule_id,rule_detail_id,is_intime,
		create_time, update_time) values (#id:INTEGER#,#fromRole#,#toRole#,#typeDetail#,
		#transId:VARCHAR#, #type:VARCHAR#,
		#fromAccountName:VARCHAR#, #fromAccountNo:VARCHAR#,
		#payValue:VARCHAR#, #toAccountName:VARCHAR#,
		#toAccountNo:VARCHAR#, #state:VARCHAR#, #step:VARCHAR#,
		#resultCode:VARCHAR#, #resultDesc:VARCHAR#,
		#remark:VARCHAR#,#fromAccountType:VARCHAR#,#toAccountType:VARCHAR#,
		#fromPhone:VARCHAR#,#toPhone:VARCHAR#,#fromId:VARCHAR#,
		#toId:VARCHAR#,#fromUsername:VARCHAR#,#toUsername:VARCHAR#,
		#channelType:VARCHAR#,#channelId:VARCHAR#,#ruleType:VARCHAR#,
		#ruleId:VARCHAR#,#ruleDetailId:VARCHAR#,#isIntime:VARCHAR#,
		DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),
		DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"))
		<selectKey keyProperty="id" resultClass="int">
			select last_insert_id() as id
		</selectKey>
	</insert>
	
	<update id="updateStateById" parameterClass="java.util.HashMap">
		update pay set update_time =DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),state=#state# where id=#id#
	</update>
	
	<!-- 以transId,type作条件，修改state,resultCode,resultDesc -->
	<update id="updatePay" parameterClass="pay">
		update pay set update_time =DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),
		state=#state#
		<isNotEmpty prepend="," property="resultCode">
			result_code=#resultCode#
		</isNotEmpty>
		<isNotEmpty prepend="," property="resultDesc">
			result_desc=#resultDesc#
		</isNotEmpty>
		where trans_id=#transId# and type=#type# and type_detail=#typeDetail#
	</update>
	
	<update id="updateById" parameterClass="pay">
		update pay set update_time =DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s")
		<dynamic>
			<isNotEmpty prepend="," property="typeDetail">
				type_detail = #typeDetail:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="transId">
				trans_id = #transId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="type">
				type = #type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fromAccountName">
				from_account_name = #fromAccountName:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fromAccountNo">
				from_account_no = #fromAccountNo:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="payValue">
				pay_value = #payValue:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toAccountName">
				to_account_name = #toAccountName:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toAccountNo">
				to_account_no = #toAccountNo:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="state">
				state = #state:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="step">
				step = #step:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="resultCode">
				result_code = #resultCode:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="resultDesc">
				result_desc = #resultDesc:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="updateTime">
				update_time = #updateTime:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="remark">
				remark = #remark:VARCHAR#
			</isNotEmpty>

			<isNotEmpty prepend="," property="fromAccountType">
				from_account_type = #fromAccountType:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toAccountType">
				to_account_type = #toAccountType:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fromPhone">
				from_phone = #fromPhone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toPhone">
				to_phone = #toPhone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fromId">
				from_id = #fromId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toId">
				to_id = #toId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fromUsername">
				from_username = #fromUsername:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="toUsername">
				to_username = #toUsername:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="channelType">
				channel_type = #channelType:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="channelId">
				channel_id = #channelId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ruleType">
				rule_type = #ruleType:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ruleId">
				rule_id = #ruleId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ruleDetailId">
				rule_detail_id = #ruleDetailId:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="isIntime">
				is_intime = #isIntime:VARCHAR#
			</isNotEmpty>
		</dynamic>
		where id = #id:INTEGER#
	</update>
	
	<!-- 查询所有含有没付款的pay记录-->	
	<select id="getAllWithoutPays" resultMap="PayResult" >
		<![CDATA[
			SELECT * from pay where trans_id in 
			(select distinct(t.id) from trans t inner join pay p on p.trans_id=t.id  where p.state="1001" 
				and (DATE_FORMAT(t.update_time,"%Y-%m-%d %H:%i:%s") BETWEEN timestamp(DATE_FORMAT(NOW(),"%Y-%m-%d %H:%i:%s"),"-168:00:00") and timestamp(DATE_FORMAT(NOW(),"%Y-%m-%d %H:%i:%s"),"-24:00:00"))
				and t.state="01")
		]]> 
	</select>
    <!--支付宝支付结果检查-->
    <select id="aliPayResultCheck" resultClass="java.lang.String" parameterClass="string">
    		SELECT state FROM pay WHERE trans_id=#transId# AND type = '00'
    	</select>
</sqlMap>