<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="user">
	
	<typeAlias alias="user" type="com.froad.CB.po.user.User"/>
	<typeAlias alias="loginManager" type="com.froad.CB.po.user.LoginManager" />
	<typeAlias alias="authorities" type="com.froad.CB.po.user.Authorities" />
	<typeAlias alias="resources" type="com.froad.CB.po.user.Resources" />
	<typeAlias alias="userSuggest" type="com.froad.CB.po.user.Suggest" />
	
	<!-- <cacheModel type="MEMORY" id="userCache">
		<flushInterval hours="24" />
		<flushOnExecute statement="test" />
		<property name="login" value="WEAK" />
	</cacheModel> -->

	<select id="queryUserByNameAndPwd" parameterClass="map" resultClass="user">
		select * from user where username=#username# and password=#password#
	</select>
	
	<!-- 查询用户所有信息 根据手机号码 或邮箱 或 sn  -->
	<select id="queryUserByMobilephoneOrMailOrSn" resultClass="user" parameterClass="java.lang.String">
		select * from user where mobilephone = #value# or email = #value# or sn = #value#
	</select>
	<!-- 查询用户所有信息 根据手机号码 或邮箱   -->
	<select id="queryUserByMobilephoneOrMail" resultClass="user" parameterClass="java.lang.String">
		select * from user where mobilephone = #value# or email = #value#
	</select>
	
	<!-- 查询用户所有信息 根据手机号码 或用户名   -->
	<select id="queryUserByMobilephoneOrUsername" resultClass="user" parameterClass="java.lang.String">
		select * from user where mobilephone = #value# or username = #value#
	</select>
	
	<!-- 根据商户名和商户密码查询用户信息  -->
	<select id="queryUserByUsernameAndSPpassword" resultClass="user" parameterClass="map">
		select * from user where username=#username# and SPpassword=#SPpassword#
	</select>
	
	<!-- 修改密码 -->
	<update id="updPassword" parameterClass="user">
		update user set password=#password# where userID = #userID#
	</update>
	
	<!-- 根据用户ID修改数据  -->
	<update id="updateUserByUserID" parameterClass="user">
		update user
		<dynamic prepend="set"> 
			<isNotEmpty prepend="," property="uname">
				uname = #uname# 
			</isNotEmpty>
			<isNotEmpty prepend="," property="username">
				username = #username# 
			</isNotEmpty>
			<isNotEmpty prepend="," property="email">
				email = #email#
			</isNotEmpty>
			<isNotEmpty prepend="," property="sex">
				sex = #sex# 
			</isNotEmpty>
			<isNotEmpty prepend="," property="age">
				age = #age#
			</isNotEmpty>
			<isNotEmpty prepend="," property="mobilephone">
				mobilephone = #mobilephone#  
			</isNotEmpty>
			<isNotNull prepend="," property="actprojectID">
				actprojectID = #actprojectID#  
			</isNotNull>
			<isNotNull prepend="," property="joinedActprojectID">
				joinedActprojectID = #joinedActprojectID#  
			</isNotNull>
		</dynamic>
		where userID = #userID# 
	</update>
	
	<!-- 根据用户名修改用户余额  -->
	<update id="updateBalanceByUsername" parameterClass="user">
		update user set balance = #balance#
		 where username = #username#
	</update>
	
	<!-- 更新user表Ip地址和登录时间  并返回上一次登录时间和ip -->
	<update id="updateUserLastInfoByUsername" parameterClass="user">
			update user 
		<dynamic prepend="set">
			<isNotEmpty prepend="," property="lastIP">
				lastIP = #lastIP:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="lastTime">
				lastTime = #lastTime:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="bank">
				bank = #bank:VARCHAR#
			</isNotEmpty>		
			<isNotEmpty prepend="," property="isAccountLocked">
				isAccountLocked = #isAccountLocked:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="loginFailureCount">
				loginFailureCount = #loginFailureCount:INTEGER#
			</isNotEmpty>
			<isNotEmpty prepend="," property="lockedDate">
				lockedDate = #lockedDate:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="lastTryTime">
				lastTryTime = #lastTryTime#
			</isNotEmpty>			
			<isNotEmpty prepend="," property="isPointActivateAccountLocked">
				isPointActivateAccountLocked = #isPointActivateAccountLocked:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pointActivateFailureCount">
				pointActivateFailureCount = #pointActivateFailureCount:INTEGER#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pointActivateLockedDate">
				pointActivateLockedDate = #pointActivateLockedDate:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="lastPointActivateTime">
				lastPointActivateTime = #lastPointActivateTime:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="firstLogin">
				firstLogin = #firstLogin:VARCHAR#
			</isNotEmpty>
		</dynamic>
		where username=#username#
	</update>
	
	 <!-- 查询逻辑卡号 是否存在  -->
    <select id="getUserInfoBySn" parameterClass="java.lang.String" resultClass="user">
		select * from user where sn=#sn#
	</select>
	
	<!-- 查询注册用户是否存在  -->
	<select id="selectAddedUser" resultClass="java.lang.String" parameterClass="user">
		select username from user 
		<dynamic prepend="where">	
			<isNotEmpty prepend="or " property="mobilephone">
					mobilephone=#mobilephone#
			</isNotEmpty>
			<isNotEmpty prepend="or " property="username">
					 username=#username# 
			</isNotEmpty> 
			<isNotEmpty prepend="or " property="email">
					 email=#email# 
			</isNotEmpty> 
		</dynamic>
	</select>
	
	<!-- 通过用户名查询用户信息  -->
	<select id="queryUserAllByUsername" resultClass="user" parameterClass="java.lang.String">
		<![CDATA[ select * from user where username=#username# ]]>
	</select>
	
	<!-- 通过用户ID查询用户信息  -->
	<select id="queryUserAllByUserID" resultClass="user" parameterClass="java.lang.String">
		<![CDATA[ select * from user where userID=#userID# ]]>
	</select>
	
	<!-- 通过手机查询用户信息  -->
	<select id="selectUserMobilephone" resultClass="user" parameterClass="java.lang.String">
		 <![CDATA[ select * from user where mobilephone=#mobilephone# ]]>
	</select>
	
	<!-- 身份证号查询用户 -->
	<select id="queryUserByIdentityKey" resultClass="user" parameterClass="java.lang.String">
		select * from user where identityKey=#identityKey#
	</select>
	
	<!-- 查询用户名是否已被注册  -->
	<select id="validateUsername" resultClass="java.lang.String" parameterClass="user">
		select username from user where username = #username#
	</select>
	
	<!-- 查询手机号码是否已被绑定  -->
	<select id="validateMobilephone" resultClass="java.lang.String" parameterClass="user">
		select username from user where username != #username# and mobilephone = #mobilephone#
	</select>
	
	<!-- 查询手机号码是否已被绑定By userID,mobilePhone  -->
	<select id="validateMobilephoneByUserID" resultClass="java.lang.String" parameterClass="user">
		select username from user where userID != #userID# and mobilephone = #mobilephone#
	</select>
	
	<!-- 查询邮箱是否已被注册 -->
	<select id="validateEmail" resultClass="java.lang.String" parameterClass="user">
		select username from user where username != #username# and email=#email#
	</select>
	
	<!-- 根据邮箱查询用户信息 -->
	<select id="selectUserEmail" resultClass="user" parameterClass="java.lang.String">
		select * from user where email=#email#
	</select>
	
	<!-- 用户注册  -->
	<insert id="add" parameterClass="user">
		INSERT INTO
		user(userID,username,password,bank,securityCode,uname,email,userrole,mobilephone,activatecode,status,sn,actprojectID,identityKey,sex,age,firstLogin,registeredTime,createChannel)
		VALUES
		(#userID#,#username#,#password#,#bank#,#securityCode#,#uname#,#email#,#userrole#,#mobilephone#,#activatecode#,#status#,#sn#,#actprojectID#,#identityKey#,#sex#,#age#,#firstLogin#,DATE_FORMAT(NOW(),"%Y-%m-%d %H:%i:%s"),'FFT')
	</insert>
	
	<!-- 获取当前最大用户角色标识 -->
	<select id="queryMaxRoleID" resultClass="java.lang.Integer">
   		select Max(user_authorities_id) from u_user_authorities 
    </select>
   
	<!-- 添加用户角色  -->
    <insert id="addrole" parameterClass="user" >
		INSERT INTO
		u_user_authorities(user_authorities_id,userID,authorities_id)
		VALUES
		(#user_authorities_id#,#userID#,'a1')	
	</insert>
	
	<select id="isActivatecodeRight" parameterClass="user" resultClass="user">
		select * from user where activatecode=#activatecode#
	</select>

	<!-- 用户激活  -->
	<update id="updateUserActivatecode" parameterClass="java.lang.String">
		update user set status=0 ,activatecode=null where activatecode=#activatecode#
	</update>
	
    <!-- 用户退出(暂不用)  -->
    <delete id="logout" parameterClass="loginManager" >
         delete from logintemp where sessionID=#sessionID# and username=#username#
    </delete>
    
    <!-- 获取用户权限  -->
    <select id="queryAuthoritiesByUsername" parameterClass="java.lang.String" resultClass="authorities">
		select u_authorities.authorities_id,u_authorities.authorities_name,u_authorities.p_authorities_id,u_authorities.p_authorities_name 
		      FROM user,u_authorities,u_user_authorities 
		      WHERE user.username=#username#
		        AND user.userID=u_user_authorities.userID
		        AND u_authorities.authorities_id=u_user_authorities.authorities_id
	</select>
	
	<!--  
    <select id="queryAuthorities" resultClass="authorities">
		select u_authorities.authorities_id,u_authorities.authorities_name,u_authorities.p_authorities_id,u_authorities.p_authorities_name 
		      FROM user,u_authorities,u_user_authorities 
		      WHERE user.userID=u_user_authorities.userID
		        AND u_authorities.authorities_id=u_user_authorities.authorities_id
	</select>
	 <select id="queryResourcesByAuthorities" parameterClass="String"  resultClass="resources">
		select u_resources.resources_id,u_resources.p_resources_name,u_resources.p_resources_id,u_resources.p_resources_name,u_resources.resources_value
                       from u_authorities_resources,u_authorities,u_resources
                       where u_authorities.authorities_id = #auth#
                         and u_authorities.authorities_id = u_authorities_resources.authorities_id
                         and u_resources.resources_id = u_authorities_resources.resources_id
	</select>
	 -->
	 
	<!-- 获取所有权限  -->
    <select id="queryAuthorities" resultClass="authorities">
		select authorities_id,authorities_name,p_authorities_id,p_authorities_name  FROM froadmall.u_authorities
	</select>
	
	<!-- 根据用户权限获取资源信息  -->
   <select id="queryResourcesByAuthorities" parameterClass="java.lang.String"  resultClass="resources">
		select u_resources.resources_id,u_resources.p_resources_name,u_resources.p_resources_id,u_resources.p_resources_name,u_resources.resources_value
               from u_authorities_resources,u_authorities,u_resources
               where u_authorities.authorities_id = #auth#
                 and(u_authorities.authorities_id = u_authorities_resources.authorities_id or u_authorities.p_authorities_id = u_authorities_resources.authorities_id)
                 and u_resources.resources_id = u_authorities_resources.resources_id
	</select>
	
	<select id="queryMaxSuggestID" resultClass="java.lang.String">
	   	select ID from u_suggest  order by ID desc limit 1
	</select>

	<insert id="addsuggest" parameterClass="userSuggest">
		INSERT INTO
		u_suggest(ID,userID,username,suggesttittle,suggestcontext,submittime,transactionID)
		VALUES
		(#ID#,#userID#,#username#,#suggesttittle#,#suggestcontext#,#submittime#,#transactionID#)		
	</insert>	
	
	<!-- 多条件分页查询用户信息    -->
	<select id="getUserByPager" parameterClass="user" resultClass="user">
		select * from user
		<dynamic prepend="where">
			<isNotEmpty property="username" prepend="and">
				username like concat('%',#username#,'%')
			</isNotEmpty>
			<isNotEmpty property="uname" prepend="and">
				uname like concat('%',#uname#,'%')
			</isNotEmpty>
			<isNotEmpty property="mobilephone" prepend="and">
				mobilephone like concat('%',#mobilephone#,'%')
			</isNotEmpty>
			<isNotEmpty property="status" prepend="and">
				status=#status#
			</isNotEmpty>
			<isNotEmpty property="authoritiesId">
				userID in(
				select distinct(userID) from u_user_authorities where 
				authorities_id=#authoritiesId#)
			</isNotEmpty>
		</dynamic>
		order by userID desc limit #startRow#,#pageSize#
	</select>
	
	<select id="getUserByPagerCount" parameterClass="user" resultClass="java.lang.Integer">
		select count(*) from user
		<dynamic prepend="where">
			<isNotEmpty property="username" prepend="and">
				username like concat('%',#username#,'%')
			</isNotEmpty>
			<isNotEmpty property="uname" prepend="and">
				uname like concat('%',#uname#,'%')
			</isNotEmpty>
			<isNotEmpty property="mobilephone" prepend="and">
				mobilephone like concat('%',#mobilephone#,'%')
			</isNotEmpty>
			<isNotEmpty property="status" prepend="and">
				status=#status#
			</isNotEmpty>
			<isNotEmpty property="authoritiesId">
				userID in(
				select distinct(userID) from u_user_authorities where 
				authorities_id=#authoritiesId#)
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="getUsersByIdList" parameterClass="java.util.ArrayList" resultClass="user">
		select * from user where userID in
		<iterate open="(" conjunction="," close=")">
			#list[]#
		</iterate>
	</select>
</sqlMap>
