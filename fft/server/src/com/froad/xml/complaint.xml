<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="complaint">
  <typeAlias alias="complaint" type="com.froad.CB.po.complaint.Complaint"/>
  <resultMap id="complaintResult" class="complaint">
    <result column="id" property="id" jdbcType="INTEGER" />
    <result column="id" property="replyList" select="complaintReply.selectByComplaintId"/>
    <result column="complaint_category_id" property="complaintCategoryId" jdbcType="VARCHAR" />
    <result column="complaint_category_id" property="complaintCategory" select="complaintCategory.selectByPrimaryKey"/>
    <result column="order_id" property="orderId" jdbcType="VARCHAR" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="is_read" property="isRead" jdbcType="VARCHAR" />
    <result column="is_reply" property="isReply" jdbcType="VARCHAR" />
    <result column="delete_status" property="deleteStatus" jdbcType="VARCHAR" />
    <result column="from_user_id" property="fromUserId" jdbcType="VARCHAR" />
    <result column="to_user_id" property="toUserId" jdbcType="VARCHAR" />
    <result column="to_user_id" property="merchant" select="merchant.getMerchantByUserId"/>
    <result column="state" property="state" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
  </resultMap>
  
  <select id="selectByPrimaryKey" resultMap="complaintResult" parameterClass="java.lang.Integer" >
        select * from complaint where id = #value#
  </select>
  
  <select id="getComplaintByPager" resultMap="complaintResult" parameterClass="complaint" >
   	select * from complaint
	<dynamic prepend="where">
	  <isNotEmpty prepend="and" property="id" >
        id = #id#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="complaintCategoryId" >
        complaint_category_id = #complaintCategoryId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="orderId" >
        order_id = #orderId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="content" >
        content = #content:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="isRead" >
        is_read = #isRead:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="isReply" >
        is_reply = #isReply:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="deleteStatus" >
        delete_status = #deleteStatus:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="fromUserId" >
        from_user_id = #fromUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="toUserId" >
        to_user_id = #toUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="state" >
        state = #state:VARCHAR#
      </isNotEmpty>
      <isNotEmpty property="beginTime">
		<isNotEmpty property="endTime" prepend="and">
			create_time between #beginTime# and #endTime#
		</isNotEmpty>
      </isNotEmpty>
    </dynamic>
    order by create_time desc limit #startRow#,#pageSize#		
  </select>
  
  <select id="getComplaintByPagerCount" resultClass="java.lang.Integer" parameterClass="complaint" >
   	select count(*) from complaint
	<dynamic prepend="where">
	  <isNotEmpty prepend="and" property="id" >
        id = #id#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="complaintCategoryId" >
        complaint_category_id = #complaintCategoryId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="orderId" >
        order_id = #orderId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="content" >
        content = #content:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="isRead" >
        is_read = #isRead:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="isReply" >
        is_reply = #isReply:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="deleteStatus" >
        delete_status = #deleteStatus:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="fromUserId" >
        from_user_id = #fromUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="toUserId" >
        to_user_id = #toUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="state" >
        state = #state:VARCHAR#
      </isNotEmpty>
      <isNotEmpty property="beginTime">
		<isNotEmpty property="endTime" prepend="and">
			create_time between #beginTime# and #endTime#
		</isNotEmpty>
      </isNotEmpty>
    </dynamic>
  </select>
  
  <delete id="deleteByPrimaryKey" parameterClass="java.lang.Integer" >
        delete from complaint where id = #value#
  </delete>
  
  <insert id="insert" parameterClass="complaint" >
	insert into complaint (id, complaint_category_id, order_id, content, is_read, is_reply,
	delete_status, from_user_id, to_user_id, state, create_time, update_time, remark)
	values (#id:INTEGER#, #complaintCategoryId:VARCHAR#, #orderId:VARCHAR#, #content:VARCHAR#,
	#isRead:VARCHAR#, #isReply:VARCHAR#, #deleteStatus:VARCHAR#, #fromUserId:VARCHAR#,
	#toUserId:VARCHAR#, #state:VARCHAR#, DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"), DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),
	#remark:VARCHAR#)
	<selectKey keyProperty="id" resultClass="int">
		select last_insert_id() as id
	</selectKey>
  </insert>
  
  <update id="updateComplaintStateById" parameterClass="java.util.HashMap">
  	update complaint set update_time = DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"), state=#state# where id=#id#
  </update>
  
  <update id="stopComplaintById" parameterClass="java.lang.Integer">
  	update complaint set delete_status="20",update_time = DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s") where id=#id#
  </update>
  
  <update id="updateByPrimaryKeySelective" parameterClass="complaint" >
    update complaint set update_time =DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s")
    <dynamic prepend="" >
      <isNotEmpty prepend="," property="complaintCategoryId" >
        complaint_category_id = #complaintCategoryId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="orderId" >
        order_id = #orderId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="content" >
        content = #content:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="isRead" >
        is_read = #isRead:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="isReply" >
        is_reply = #isReply:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="deleteStatus" >
        delete_status = #deleteStatus:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="fromUserId" >
        from_user_id = #fromUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="toUserId" >
        to_user_id = #toUserId:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="state" >
        state = #state:VARCHAR#
      </isNotEmpty>
      <isNotEmpty prepend="," property="remark" >
        remark = #remark:VARCHAR#
      </isNotEmpty>
    </dynamic>
    where id = #id:INTEGER#
  </update>
</sqlMap>