<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="userAppend">
	<typeAlias alias="userAppend" type="com.froad.CB.po.user.UserAppend"/>
	
	<resultMap class="userAppend" id="userAppendResult">
		<result property="id" column="id" jdbcType="VARCHAR"/>
		<result property="userID" column="userID" jdbcType="INT"/>
		<result property="isPointActivateLock" column="isPointActivateLock" jdbcType="VARCHAR"/>
		<result property="pointActivateFailureTimes" column="pointActivateFailureTimes" jdbcType="INT"/>
		<result property="pointActivateLockTime" column="pointActivateLockTime" jdbcType="VARCHAR"/>
		<result property="pointActivateTryTime" column="pointActivateTryTime" jdbcType="VARCHAR"/>
		<result property="firstLogin" column="firstLogin" jdbcType="VARCHAR"/>
		<result property="bank" column="bank" jdbcType="VARCHAR"/>
		<result property="activateCode" column="activateCode" jdbcType="VARCHAR"/>
		<result property="blance" column="blance" jdbcType="VARCHAR"/>
		<result property="state" column="state" jdbcType="VARCHAR"/>
		<result property="create_time" column="create_time" jdbcType="VARCHAR"/>
		<result property="update_time" column="update_time" jdbcType="VARCHAR"/>
		<result property="remark" column="remark" jdbcType="VARCHAR"/>	
	</resultMap>
	
	<insert id="addUserAppend" parameterClass="userAppend">
		insert into 
		userappend(id,userID,isPointActivateLock,pointActivateFailureTimes,pointActivateLockTime,pointActivateTryTime,firstLogin,bank,activateCode,blance,state,create_time,update_time,remark) 
		values (#id#,#userID#,#isPointActivateLock#,#pointActivateFailureTimes#,#pointActivateLockTime#,#pointActivateTryTime#,#firstLogin#,#bank#,#activateCode#,#blance#,#state#,DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),DATE_FORMAT(NOW(),"%Y-%m-%d|%H:%i:%s"),#remark#)
		<selectKey keyProperty="id" resultClass="int" type="post">
		   select last_insert_id() as id
		</selectKey>
	</insert>
	
	
	<select id="getUserAppendByUserId" parameterClass="java.lang.String" resultMap="userAppendResult">
		select * from userappend where userID=#userID#
	</select>
	
	<update id="updateUserAppend" parameterClass="userAppend">
		update userappend set update_time=DATE_FORMAT(NOW(),"%Y-%m-%d %H:%i:%s")
		<dynamic >
			<isNotEmpty prepend="," property="isPointActivateLock">
				isPointActivateLock=#isPointActivateLock#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pointActivateFailureTimes">
				pointActivateFailureTimes=#pointActivateFailureTimes#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pointActivateLockTime">
				pointActivateLockTime=#pointActivateLockTime#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pointActivateTryTime">
				pointActivateTryTime=#pointActivateTryTime#
			</isNotEmpty>
			<isNotEmpty prepend="," property="firstLogin">
				firstLogin=#firstLogin#
			</isNotEmpty>
			<isNotEmpty prepend="," property="bank">
				bank=#bank#
			</isNotEmpty>
			<isNotEmpty prepend="," property="activateCode">
				activateCode=#activateCode#
			</isNotEmpty>
			<isNotEmpty prepend="," property="blance">
				blance=#blance#
			</isNotEmpty>
			<isNotEmpty prepend="," property="state">
				state=#state#
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				create_time=#create_time#
			</isNotEmpty>
			<isNotEmpty prepend="," property="remark">
				remark=#remark#
			</isNotEmpty>
		</dynamic>
		where userID=#userID#
	</update>





	<!-- 用户权限相关-->
	<!-- 获取当前最大用户角色标识 -->
	<select id="queryMaxRoleID" resultClass="java.lang.Integer">
	 	select Max(user_authorities_id) from `u_user_authorities` 
	</select>
	
	<!-- 添加用户角色  -->
	<insert id="addrole" parameterClass="com.froad.CB.po.user.User" >
		INSERT INTO	u_user_authorities(user_authorities_id,userID,authorities_id)
		VALUES (#user_authorities_id#,#userID#,'a1')	
	</insert>
	
	<typeAlias alias="authorities" type="com.froad.CB.po.user.Authorities" />
	<typeAlias alias="resources" type="com.froad.CB.po.user.Resources" />
	<!-- 获取用户权限  -->
    <select id="queryAuthoritiesByUsername" parameterClass="java.lang.String" resultClass="authorities">
		select u_authorities.authorities_id,u_authorities.authorities_name,u_authorities.p_authorities_id,u_authorities.p_authorities_name 
		FROM u_authorities,u_user_authorities 
		WHERE u_user_authorities.userID = #userid#   AND u_authorities.authorities_id=u_user_authorities.authorities_id
	</select>
	<!-- 获取所有权限  -->
    <select id="queryAuthorities" resultClass="authorities">
		select authorities_id,authorities_name,p_authorities_id,p_authorities_name  FROM u_authorities
	</select>
	<!-- 根据用户权限获取资源信息  -->
   <select id="queryResourcesByAuthorities" parameterClass="java.lang.String"  resultClass="resources">
		select u_resources.resources_id,u_resources.p_resources_name,u_resources.p_resources_id,u_resources.p_resources_name,u_resources.resources_value
               from u_authorities_resources,u_authorities,u_resources
               where u_authorities.authorities_id = #auth#
                 and(u_authorities.authorities_id = u_authorities_resources.authorities_id or u_authorities.p_authorities_id = u_authorities_resources.authorities_id)
                 and u_resources.resources_id = u_authorities_resources.resources_id
	</select>
	
</sqlMap>
