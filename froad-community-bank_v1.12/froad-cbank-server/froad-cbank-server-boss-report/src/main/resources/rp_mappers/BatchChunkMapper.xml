<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.rp_mappers.BatchChunkMapper">
	<!-- columns to update -->
	<sql id="updateColumns">
		<if test="startTime != null">
			start_time = #{startTime} ,
		</if>
		<if test="endTime != null">
			end_time = #{endTime} ,
		</if>
		<if test="status != null">
			status = #{status} ,
		</if>				
	</sql>
	
	<resultMap type="BatchChunk" id="BatchChunkRM">
		<result property="chunkId" column="chunk_id"/>
		<result property="batchDate" column="batch_date"/>
		<result property="lastBatchDate" column="last_batch_date"/>
		<result property="batchId" column="batch_id"/>
		<result property="nodeId" column="node_id"/>
		<result property="jobId" column="job_id"/>
		<result property="jobName" column="job_name"/>
		<result property="inputFile" column="input_file"/>
		<result property="chunkPage" column="chunk_page"/>
		<result property="chunkSize" column="chunk_size"/>
		<result property="totalChunk" column="total_chunk"/>
		<result property="totalSize" column="total_size"/>
		<result property="startTime" column="start_time"/>
		<result property="endTime" column="end_time"/>
		<result property="status" column="status"/>
	</resultMap>
	
	<update id="updateBatchChunk" parameterType="BatchChunk">
		update cb_report_batch_chunk 
		<set><include refid="updateColumns"/></set>
		where chunk_id = #{chunkId} and batch_date = #{batchDate} and job_id = #{jobId}
	</update>	
	
	<select id="findBatchChunk" resultMap="BatchChunkRM">
		select chunk_id,batch_date,last_batch_date,batch_id,node_id,job_id,job_name,input_file,chunk_page,chunk_size,total_chunk,total_size,start_time,end_time,status 
		from cb_report_batch_chunk 
		<where>
			<if test="batchDate != null">
				AND batch_date=#{batchDate} 
			</if>
			<if test="jobId != null">
				AND job_id=#{jobId} 
			</if>
			<if test="jobName != null">
				AND job_name=#{jobName} 
			</if>			
			<if test="status != ' '">
				AND status=#{status} 
			</if>
			<if test="nodeId != null">
				AND node_id=#{nodeId} 
			</if>										
		</where>		
	</select>
	
	<select id="findActiveBatchChunk" resultMap="BatchChunkRM">
		select chunk_id,batch_date,last_batch_date,batch_id,node_id,job_id,job_name,input_file,chunk_page,chunk_size,total_chunk,total_size,start_time,end_time,status 
		from cb_report_batch_chunk 
		where status = '0' and job_name = #{jobName} and 
		node_id in (select node_id from cb_report_batch_node as a where a.node_ip = #{nodeIp} and a.node_port = #{nodePort})
		order by node_id, job_id, batch_date, chunk_id
	</select>	
	
	<insert id="addByBatch">
		INSERT INTO cb_report_batch_chunk(
			chunk_id,batch_date,last_batch_date,batch_id,node_id,job_id,job_name,input_file,chunk_page,chunk_size,total_chunk,total_size,start_time,end_time,status
		) VALUES 
		<foreach collection="chunks" item="item" index="index" separator=",">
			(#{item.chunkId},#{item.batchDate},#{item.lastBatchDate},#{item.batchId},#{item.nodeId},
			#{item.jobId},#{item.jobName},#{item.inputFile},#{item.chunkPage},#{item.chunkSize},
			#{item.totalChunk},#{item.totalSize},#{item.startTime},#{item.endTime},#{item.status})
		</foreach>
	</insert>
	
	
	<select id="findEndBatchChunk" resultType="java.util.Date">
		SELECT MAX(t1.end_time) max 
		FROM cb_report_batch_chunk t1 JOIN cb_report_batch_job t2 ON t1.job_id = t2.job_id 
		<where>
			t1.status = 2 AND end_time IS NOT NULL 
			<if test="batchDate != null">
				AND t1.batch_date = #{batchDate} 
			</if>
		</where>
		GROUP BY 
			t1.job_id 
		ORDER BY 
			max DESC
	</select>
	
	<delete id="deleteHistoryData" parameterType="java.lang.Integer">
		DELETE FROM cb_report_batch_chunk WHERE batch_date = #{batchDate}
	</delete>
	
</mapper>