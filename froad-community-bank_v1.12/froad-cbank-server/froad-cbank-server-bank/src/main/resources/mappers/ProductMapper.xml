<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.ProductMapper">

	<resultMap type="BankAudit" id="productResultMap">
		<result property="auditId" column="product_id" />
		<result property="clientId" column="client_id" />
		<result property="merchantId" column="merchant_id" />
		<result property="orgCode" column="org_code" />
		<result property="auditComment" column="audit_comment" />
		<result property="auditTime" column="audit_time" />
		<result property="auditState" column="audit_state" />
		<result property="auditOrgCode" column="audit_org_code" />
		<result property="auditStage" column="audit_stage" />
		<result property="auditStaff" column="audit_staff" />
		<result property="reviewStaff" column="review_staff" />
		<result property="name" column="name" />
		<result property="type" column="type" />
		<result property="isMarketable" column="is_marketable" />
		<result property="auditStartOrgCode" column="audit_start_org_code" />
		<result property="auditEndOrgCode" column="audit_end_org_code" />
		<result property="rackTime" column="rack_time" /> <!-- 20151019 ll add 上架时间 -->
	</resultMap>
	
	<resultMap type="ProductOutletInfo" id="outletResultMap">
		<id property="id" column="id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="merchantId" column="merchant_id" />
		<result property="outletId" column="outlet_id" />
		<result property="areaId" column="area_id" />
		<result property="outletName" column="outlet_name" />
		<result property="outletFullname" column="outlet_fullname" />
		<result property="outletStatus" column="outlet_status" />
		<result property="address" column="address" />
		<result property="areaParentId" column="parent_id" />
	</resultMap>
	
	<!-- 根据商品id获取商品信息 -->
	<select id="findProductById" parameterType="BankAudit" resultMap="productResultMap">
		select 
			client_id,merchant_id,org_code,audit_org_code,audit_stage,type,name,audit_start_org_code,audit_end_org_code   
		from cb_product 
			where audit_state='0' and product_id=#{auditId}  
	</select>

	<!-- 查询待审核数量 -->
	<select id="findCountByProduct" resultType="java.util.Map">
		select  type,count(0) auditCount  from cb_product  
			where audit_state='0' and client_id=#{clientId}  and audit_org_code=#{auditOrgCode}  and is_marketable!='3'  
			group by type
	</select>
	
	<!-- 审核  Product -->
	<update id="auditProduct" parameterType="BankAudit">
		update cb_product 
		<set>
			<if test="auditTime != null">
				 audit_time = #{auditTime}, 
			</if>
			<if test="auditComment != null">
				 audit_comment = #{auditComment},
			</if>
			<if test="auditState != null">
				 audit_state = #{auditState},
			</if>
			<if test="auditOrgCode != null">
				 audit_org_code = #{auditOrgCode},
			</if>
			<if test="auditStage != null">
				 audit_stage = #{auditStage},
			</if>
			<if test="reviewStaff != null">
				 review_staff = #{reviewStaff},
			</if>
			<if test="auditStaff != null">
				 audit_staff = #{auditStaff},
			</if>
			<if test="isMarketable != null">
				 is_marketable = #{isMarketable},  
			</if>
			<if test="rackTime != null">
				 rack_time = #{rackTime}, 
			</if>
		</set>
		<where>
			<if test="clientId != null">
				 AND client_id = #{clientId}
			</if>
			<if test="auditId != null">
				 AND product_id = #{auditId}
			</if>
			<if test="merchantId != null">
				 AND merchant_id = #{merchantId}
			</if>
		</where>
	</update>
	
	<!-- 查询区域 -->
	<select id="findOutletAreas" parameterType="Map" resultMap="outletResultMap">
		<![CDATA[
		SELECT 
            o.id,o.create_time,o.client_id,o.merchant_id,o.outlet_id,o.area_id,o.outlet_name,o.outlet_fullname,o.outlet_status,o.address,a.parent_id
        FROM cb_outlet o
        LEFT JOIN cb_area a ON o.area_id=a.id AND a.is_enable=1
        WHERE o.is_enable = 1
        ]]>
        <if test="clientId != null and clientId != ''">
             AND o.client_id = #{clientId}
        </if>
        <if test="outletId != null and outletId != ''">
             AND o.outlet_id = #{outletId}
        </if>
        <if test="areaId != null">
             AND o.area_id = #{areaId}
        </if>
        <if test="outletIds!=null and outletIds.size>0">
             AND o.outlet_id IN  
             <foreach collection="outletIds" item="item" open="(" separator="," close=")">
                      #{item}
             </foreach>
        </if>
	</select>
	
	<!-- 修改商品秒杀标识(审核秒杀商品通过时，更新商品isSeckill) -->
	<update id="updateProductIsSeckill" parameterType="Product" >
		update cb_product set is_seckill = #{isSeckill}
		<where>
			client_id = #{clientId} and product_id = #{productId}
		</where>
	</update>
	
</mapper>

