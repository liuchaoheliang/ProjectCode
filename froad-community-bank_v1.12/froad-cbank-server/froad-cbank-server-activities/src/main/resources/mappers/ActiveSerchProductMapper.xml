<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.ActiveSerchProductMapper">

	<resultMap type="ActiveResultInfo" id="activeResultProductInfo">
		<result property="id" column="element_id" />
		<result property="activeId" column="active_id" />
		<result property="activeName" column="active_name" />
		<result property="activeType" column="type" />
	</resultMap>
	
	<resultMap type="WeightActivityTag" id="weightActivityMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="activityId" column="activity_id" />
		<result property="elementId" column="element_id" />
	</resultMap>
	
		
	<!-- 查询  ActiveResultInfo -->
	<select id="findActiveProductInfo" parameterType="ActiveSearchProductInfo" resultMap="activeResultProductInfo">
		<![CDATA[
			select  w.element_id,a.active_id,a.active_name,a.type from
			cb_active_base_rule a LEFT JOIN cb_active_tag_relation r on a.active_id = r.active_id
			LEFT JOIN  cb_weight_activity_tag w on w.activity_id = r.item_id
			WHERE  a.status = '3' AND (a.type = '1' or a.type = '0')
		]]>
        <if test="clientId != null and  clientId != ''">
		    AND w.client_id = #{clientId}
	    </if>
		     AND  w.element_id in
		<foreach item="productIdList" index="index" collection="productIdList" open="(" separator="," close=")">
             #{productIdList}
        </foreach>
        	 ORDER BY w.element_id
	</select>
	
	<!-- 查询逾期活动信息 -->
	<select id ="findOverdueActivitiesByIds" parameterType = "java.util.List" resultMap = "activeResultProductInfo">
		select a.active_id, a.active_name, a.type from cb_active_base_rule a 
		where a.expire_end_time <![CDATA[<]]> SYSDATE() 
		AND a.active_id in
		<foreach item="activeIdList" index="index" collection="activeIdList" open="(" separator="," close=")">
             #{activeIdList}
        </foreach>
	</select>
	
	<select id="findProductIdSet" parameterType="java.lang.String" resultMap ="weightActivityMap">
		select w.element_id from 
		cb_active_tag_relation r,cb_weight_activity_tag w
		where w.activity_id = r.item_id
		<if test="activeId != null and  activeId != ''">
			and r.active_id = #{activeId}
		</if>
		<if test="clientId != null and  clientId != ''">
			and r.client_id = #{clientId} 
		</if>
		    and r.item_type = '3'
	</select>
	
	<select id="findProductIdSetByMerchant" parameterType="java.lang.String" resultMap ="weightActivityMap">
		select p.product_id from 
		cb_active_tag_relation r,cb_weight_activity_tag w,cb_product p
		where w.activity_id = r.item_id and p.merchant_id = w.element_id 
		<if test="activeId != null and  activeId != ''">
		 	and r.active_id = #{activeId}
		</if>
		<if test="clientId != null and  clientId != ''">
		 	and r.client_id = #{clientId}
		</if>
		    and r.item_type = '1';
	</select>
	
	<select id="findProductIdSetByOutlet" parameterType="java.lang.String" resultMap ="weightActivityMap">
		select p.product_id from 
		cb_active_tag_relation r,cb_weight_activity_tag w,cb_product p,cb_outlet o
		where w.activity_id = r.item_id and p.merchant_id = o.merchant_id  
		and r.item_type = w.activity_type 
		<if test="activeId != null and  activeId != ''">
			and r.active_id = #{activeId}
		</if>
		<if test="clientId != null and  clientId != ''">
			and r.client_id = #{clientId}
		</if>
		    and r.item_type = '2';
	</select>
</mapper>

