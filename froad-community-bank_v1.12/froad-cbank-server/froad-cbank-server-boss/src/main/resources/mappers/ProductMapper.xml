<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.ProductMapper">

	<resultMap type="Product" id="productResultMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="productId" column="product_id" />
		<result property="isMarketable" column="is_marketable" />
		<result property="createTime" column="create_time" />
		<result property="type" column="type" />
		<result property="name" column="name" />
		<result property="auditState" column="audit_state" />
		<result property="categoryTreePath" column="category_tree_path" />
		<result property="platType" column="plat_type" />
		<result property="merchantId" column="merchant_id" />
		<result property="orgCode" column="org_code" />
		<result property="rackTime" column="rack_time" />
		<result property="downTime" column="down_time" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="deliveryOption" column="delivery_option" />
		<result property="fullName" column="full_name" />
		<result property="price" column="price" />
		<result property="cost" column="cost" />
		<result property="marketPrice" column="market_price" />
		<result property="weight" column="weight" />
		<result property="weightUnit" column="weight_unit" />
		<result property="store" column="store" />
		<result property="isBest" column="is_best" />
		<result property="isLimit" column="is_limit" />
		<result property="point" column="point" />
		<result property="briefIntroduction" column="brief_introduction" />
		<result property="introduction" column="introduction" />
		<result property="buyKnow" column="buy_know" />
		<result property="auditOrgCode" column="audit_org_code" />
		<result property="auditStartOrgCode" column="audit_start_org_code" />
		<result property="auditEndOrgCode" column="audit_end_org_code" /> 
		<result property="auditStage" column="audit_stage" />
		<result property="auditTime" column="audit_time" />
		<result property="auditComment" column="audit_comment" />
		<result property="reviewStaff" column="review_staff" />
		<result property="auditStaff" column="audit_staff" />
		<result property="orderValue" column="order_value" />
		<result property="sellCount" column="sell_count" />
		<result property="deliveryMoney" column="delivery_money" />
		<result property="isSeckill" column="is_seckill" />
		<result property="proOrgCode" column="province_agency" />
		<result property="cityOrgCode" column="city_agency" />
		<result property="countryOrgCode" column="county_agency" />
		<result property="merchantName" column="merchant_name" />
		<result property="isPoint" column="is_point" />
		<result property="vipPrice" column="vip_price" />
	</resultMap>
	
	
	<resultMap type="ProductGroup" id="productGroupResultMap">
		<id property="id" column="id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="productId" column="product_id" />
		<result property="trueBuyerNumber" column="true_buyer_number" />
		<result property="virtualBuyerNumber" column="virtual_buyer_number" />
		<result property="expireStartTime" column="expire_start_time" />
		<result property="expireEndTime" column="expire_end_time" />
	</resultMap>
	
	
	<resultMap type="ProductPresell" id="productPresellResultMap">
		<id property="id" column="id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="productId" column="product_id" />
		<result property="productSupplier" column="product_supplier" />
		<result property="maxPerOutlet" column="max_per_outlet" />
		<result property="deliveryStartTime" column="delivery_start_time" />
		<result property="deliveryEndTime" column="delivery_end_time" />
		<result property="trueBuyerNumber" column="true_buyer_number" />
		<result property="virtualBuyerNumber" column="virtual_buyer_number" />
		<result property="clusterState" column="cluster_state" />
		<result property="clusterType" column="cluster_type" />
		<result property="expireStartTime" column="expire_start_time" />
		<result property="expireEndTime" column="expire_end_time" />
	</resultMap>
	
	
	<resultMap type="ProductOutletInfo" id="outletResultMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="outletId" column="outlet_id" />
		<result property="outletName" column="outlet_name" />
		<result property="address" column="address" />
		<result property="phone" column="phone" />
		<result property="areaId" column="area_id" />
		<result property="areaName" column="name" />
		<result property="areaTreePath" column="tree_path" />
		<result property="orgCode" column="org_code" />
	</resultMap>
	
	<!-- 商品管理分页查询 -->
	<select id="findProductListByPage" parameterType="java.util.HashMap" resultMap="productResultMap" >
		select id,create_time,client_id,product_id,type,name,category_tree_path,audit_state,is_marketable,plat_type 
		from cb_product 
		<where>
			type != '6' 
		<if test="p.clientId != null and p.clientId !=''">
			 AND client_id = #{p.clientId}
		</if>
		<if test="p.type != null and p.type != ''">
			 AND type = #{p.type}
		</if>
		<if test="p.auditStatus != null and p.auditStatus != ''">
			 AND audit_state = #{p.auditStatus}
		</if>
		<if test="p.excludeAuditState != null and p.excludeAuditState != ''">
			<![CDATA[
			 AND audit_state<>#{p.excludeAuditState}
			]]>
		</if>
		<if test="p.marketableStatus =='0'.toString()">
			 AND is_marketable = '0'
		</if>
		<if test="p.marketableStatus =='1'.toString()">
			 AND is_marketable = '1'
		</if>
		<if test="p.marketableStatus =='2'.toString() or p.marketableStatus =='4'.toString()">
			 AND (is_marketable = '2' OR is_marketable = '4')
		</if>
		<if test="p.name != null and p.name != ''">
		 AND name LIKE CONCAT('%',#{p.name},'%') 
		</if>
		<if test="p.platType != null and p.platType != ''">
			 AND plat_type = #{p.platType} 
		</if>
		<if test="p.excludeStatuts != null and p.excludeStatuts != ''">
			<![CDATA[
			 AND is_marketable<>#{p.excludeStatuts} 
			]]>
		</if>
		<if test="p.categoryTreePath != null and p.categoryTreePath != ''">
			 AND category_tree_path LIKE CONCAT(#{p.categoryTreePath},'%') 
		</if>
		</where>
      	 ORDER BY create_time DESC 
	</select>
	
	
	<!-- 添加  Product -->
	<insert id="addProduct" parameterType="Product" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			insert into cb_product (
				create_time,client_id,merchant_id,merchant_name,org_code,product_id,is_marketable,rack_time,down_time,type,delivery_option,name,
				full_name,price,cost,market_price,weight,weight_unit,store,is_best,is_limit,point,brief_introduction,introduction,buy_know,
				audit_state,audit_time,audit_org_code,audit_stage,audit_comment,review_staff,audit_staff,order_value,sell_count,start_time,end_time,
				delivery_money,is_seckill,province_agency,city_agency,county_agency,audit_start_org_code,audit_end_org_code,category_tree_path,plat_type,
				is_point,vip_price 
			) values (
				#{createTime},#{clientId},#{merchantId},#{merchantName},#{orgCode},#{productId},#{isMarketable},#{rackTime},#{downTime},#{type},#{deliveryOption},#{name},
				#{fullName},#{price},#{cost},#{marketPrice},#{weight},#{weightUnit},#{store},#{isBest},#{isLimit},#{point},#{briefIntroduction},#{introduction},#{buyKnow},
				#{auditState},#{auditTime},#{auditOrgCode},#{auditStage},#{auditComment},#{reviewStaff},#{auditStaff},#{orderValue},#{sellCount},#{startTime},#{endTime},
				#{deliveryMoney},#{isSeckill},#{proOrgCode},#{cityOrgCode},#{countryOrgCode},#{auditStartOrgCode},#{auditEndOrgCode},#{categoryTreePath},#{platType},
				#{isPoint},#{vipPrice}
			) 
		]]>
	</insert>


	<!-- 添加  ProductPresell -->
	<insert id="addProductPresell" parameterType="ProductPresell" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			insert into cb_product_presell (
				create_time,client_id,product_id,product_supplier,max_per_outlet,delivery_start_time,delivery_end_time,true_buyer_number,virtual_buyer_number,cluster_state,cluster_type,expire_start_time,expire_end_time
			) values (
				#{createTime},#{clientId},#{productId},#{productSupplier},#{maxPerOutlet},#{deliveryStartTime},#{deliveryEndTime},#{trueBuyerNumber},#{virtualBuyerNumber},#{clusterState},#{clusterType},#{expireStartTime},#{expireEndTime}
			) 
		]]>
	</insert>
	
	<!-- 添加  ProductGroup -->
	<insert id="addProductGroup" parameterType="ProductGroup" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			insert into cb_product_group (
				create_time,client_id,product_id,true_buyer_number,virtual_buyer_number,expire_start_time,expire_end_time
			) values (
				#{createTime},#{clientId},#{productId},#{trueBuyerNumber},#{virtualBuyerNumber},#{expireStartTime},#{expireEndTime}
			) 
		]]>
	</insert>
	
	
	<!-- 查询  Outlet -->
	<select id="findOutletById" parameterType="Map" resultMap="outletResultMap">
		<![CDATA[
		SELECT 
            o.id,o.client_id,o.outlet_id,o.outlet_name,o.address,o.phone,o.area_id,a.name,a.tree_path,org.org_code 
        FROM cb_outlet o
        LEFT JOIN cb_area a ON o.area_id=a.id AND a.is_enable=1
        LEFT JOIN cb_org org ON org.outlet_id=o.outlet_id 
        WHERE o.is_enable = 1
        ]]>
        <if test="outletId != null and outletId != ''">
             AND o.outlet_id = #{outletId}
        </if>
        <if test="clientId != null and clientId != ''">
             AND o.client_id = #{clientId}
        </if>
         LIMIT 1
	</select>

	<!-- 删除  Product -->
	<update id="deleteLogicProduct" parameterType="Product">
		update cb_product set is_marketable = #{isMarketable} 
		where product_id = #{productId}
	</update>
	
	<!-- 上下架商品  Product -->
	<update id="updateProductStatus" parameterType="Product">
		update cb_product 
		set is_marketable = #{isMarketable}
			<if test="rackTime != null">
				 , rack_time = #{rackTime}
			</if>
			<if test="downTime != null">
				 , down_time = #{downTime}
			</if>
		 where product_id = #{productId}
	</update>
	

	<!-- 修改  Product -->
	<update id="updateProduct" parameterType="Product">
		update cb_product 
		<set>
			<if test="store != null">
				store = #{store},
			</if>
			<if test="startTime != null">
				start_time = #{startTime},
			</if>
			<if test="endTime != null">
				end_time = #{endTime},
			</if>
			<if test="auditState != null">
				audit_state = #{auditState},
			</if>
			<if test="isMarketable != null">
				is_marketable = #{isMarketable},
			</if>
			<if test="downTime != null">
				down_time = #{downTime},
			</if>
			<if test="deliveryOption!=null">
				delivery_option = #{deliveryOption},
			</if>
			<if test="name!=null">
				name = #{name},
			</if>
			<if test="fullName!=null">
				full_name = #{fullName},
			</if>
			<if test="price!=null">
				price = #{price},
			</if>
			<if test="marketPrice!=null">
				market_price = #{marketPrice},
			</if>
			<if test="weight!=null">
				weight = #{weight},
			</if>
			<if test="weightUnit!=null">
				weight_unit = #{weightUnit},
			</if>
			<if test="isLimit!=null">
				is_limit = #{isLimit},
			</if>
			<if test="briefIntroduction!=null">
				brief_introduction = #{briefIntroduction},
			</if>
			<if test="introduction!=null">
				introduction = #{introduction},
			</if>
			<if test="buyKnow!=null">
				buy_know = #{buyKnow},
			</if>
			<if test="deliveryMoney!=null">
				delivery_money = #{deliveryMoney},
			</if>
			<if test="categoryTreePath!=null">
				category_tree_path=#{categoryTreePath},
			</if>
		</set>
         where product_id = #{productId}
	</update>


	<!-- 修改  ProductPresell -->
	<update id="updateProductPresell" parameterType="ProductPresell">
		update cb_product_presell set 
             product_supplier = #{productSupplier}
            , max_per_outlet = #{maxPerOutlet}
            , delivery_start_time = #{deliveryStartTime}
            , delivery_end_time = #{deliveryEndTime}
            , true_buyer_number = #{trueBuyerNumber}
            , virtual_buyer_number = #{virtualBuyerNumber}
            , cluster_state = #{clusterState}
            , cluster_type = #{clusterType}
            , expire_start_time = #{expireStartTime}
            , expire_end_time = #{expireEndTime}
          where product_id = #{productId}
	</update>
	
	<!-- 查询  Product -->
	<select id="getProductByProductId" parameterType="String" resultMap="productResultMap">
		SELECT id,client_id,merchant_id,merchant_name,org_code,product_id,is_marketable,create_time,rack_time,down_time,create_time,start_time,end_time,type,
			delivery_option,name,full_name,price,market_price,weight,weight_unit,store,is_best,is_limit,point,brief_introduction,
			introduction,buy_know,audit_state,audit_org_code,audit_start_org_code,audit_end_org_code,audit_stage,audit_time,audit_comment,
			review_staff,audit_staff,order_value,sell_count,delivery_money,is_seckill,province_agency,city_agency,county_agency,category_tree_path,plat_type 
		FROM cb_product WHERE product_id = #{productId} LIMIT 1 
	</select>
	
	<!-- 查询  ProductPresell -->
	<select id="getProductPresellByProductId" parameterType="String" resultMap="productPresellResultMap">
		SELECT id,client_id,create_time,product_id,product_supplier,max_per_outlet,delivery_start_time,delivery_end_time,
			   true_buyer_number,virtual_buyer_number,cluster_state,cluster_type,expire_start_time,expire_end_time    
		FROM cb_product_presell WHERE product_id = #{productId} LIMIT 1
	</select>
	
	<!-- 查询  ProductGroup -->
	<select id="getProductGroupByProductId" parameterType="String" resultMap="productGroupResultMap">
		SELECT id,client_id,create_time,product_id,true_buyer_number,virtual_buyer_number,expire_start_time,expire_end_time    
		FROM cb_product_group WHERE product_id = #{productId} LIMIT 1
	</select>
	
	<!-- 查询秒杀商品 -->
	<select id="getSeckillProduct" parameterType="Product" resultMap="productResultMap">
		SELECT product_id,end_time 
		FROM cb_product_seckill 
		WHERE product_id=#{productId} LIMIT 1
	</select>
	
	<!-- 审核  Product -->
	<update id="updateAuditProduct" parameterType="Product">
		update cb_product set audit_time = #{auditTime} 
            , audit_comment = #{auditComment}
			, audit_state = #{auditState}
			, is_marketable = #{isMarketable}
			<if test="auditStage != null and auditStage != ''">
			, audit_stage = #{auditStage}
			</if>
			<if test="reviewStaff != null and reviewStaff != ''">
			, review_staff = #{reviewStaff}
			</if>
			<if test="auditStaff != null and auditStaff != ''">
			, audit_staff = #{auditStaff}
			</if>
		 where product_id = #{productId}
	</update>
	
	<!-- 查询预售商品信息 -->
	<select id="getProductPresellByType" resultMap="productPresellResultMap">
	SELECT product_id,delivery_start_time,delivery_end_time FROM cb_product_presell 
	</select>
	
	<!-- 导入商品分类 -->
	<update id="updateProductCategroy">
		update cb_product set 
			<if test="productCategoryId != null and productCategoryId != ''">
				category_tree_path = #{productCategoryId}
			</if>
	 	where product_id = #{productId}
	</update>
	
	<select id="findProductListByCategoryId" resultMap="productResultMap">
		select id,create_time,client_id,product_id,type,name,category_tree_path,audit_state,is_marketable,plat_type 
		from cb_product t where t.client_id = #{clientId} and t.category_tree_path LIKE CONCAT('%',#{categoryId})
	</select>
</mapper>

