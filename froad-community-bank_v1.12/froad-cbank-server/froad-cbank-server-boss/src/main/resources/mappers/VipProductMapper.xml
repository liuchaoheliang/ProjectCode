<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.VipProductMapper">

	<resultMap type="VipProduct" id="vipProductResultMap">
		<id property="id" column="id" />
		<result property="vipId" column="vip_id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="clientName" column="client_name" />
		<result property="activitiesName" column="activities_name" />
		<result property="vipPrice" column="vip_price" />
		<result property="status" column="status" />
		<result property="count" column="count" />
		<result property="remark" column="remark" />
	</resultMap>
	
	<resultMap type="VipBindProductInfo" id="vipBindProductInfoMap">
		<result property="productId" column="product_id" />
		<result property="vipId" column="vip_id" />
		<result property="createTime" column="create_time" />
		<result property="vipPrice" column="vip_price" />
		<result property="vipLimit" column="vip_limit" />
	</resultMap>
	
	<!-- 根据vipId查询VIP规则 -->
	<select id="getVipProduct" parameterType="String" resultMap="vipProductResultMap">
		<![CDATA[
		SELECT id,vip_id,create_time,client_id,client_name,activities_name,vip_price,status,count,remark  
		FROM cb_vip_product WHERE vip_id = #{vipId} AND status <>'3' LIMIT 1
		]]> 
	</select>

	
	<!-- vip规则列表查询 -->
	<select id="findVipProductByList" parameterType="java.util.HashMap" resultMap="vipProductResultMap" >
		<![CDATA[
		SELECT id,vip_id,create_time,client_id,client_name,activities_name,vip_price,status,count,remark  
		FROM cb_vip_product WHERE 1=1
		]]> 
		<if test="vip.clientId != null and vip.clientId !=''">
			 AND client_id = #{vip.clientId} 
		</if>
		<if test="vip.status != null and vip.status != ''">
			 AND status = #{vip.status} 
		</if>
		ORDER BY create_time DESC  
	</select>
	
	<!-- 保存绑定关系中间表 -->
	<insert id="addVipBindProducts" parameterType="java.util.List">  
		INSERT INTO cb_vip_bind_product (product_id,vip_id,create_time,vip_price,vip_limit) 
		VALUES 
		<foreach collection="list" item="item" index="index" separator="," >  
        (#{item.productId},#{item.vipId},#{item.createTime},#{item.vipPrice},#{item.vipLimit})  
		</foreach>
	</insert> 
	
	<!-- 更新Vip已经绑定商品数量 -->
	<update id="updateVipCount" parameterType="VipProduct">
		UPDATE cb_vip_product SET count = count+#{count}  
		WHERE vip_id = #{vipId}
	</update>
	
	
	<!-- 分页查询vip规则绑定关系的中间表 -->
	<select id="findVipBindProduct" parameterType="String" resultMap="vipBindProductInfoMap" >
		<![CDATA[
		SELECT product_id,vip_id,create_time,vip_price,vip_limit 
		FROM cb_vip_bind_product 
		WHERE product_id=#{productId} LIMIT 1
		]]> 
	</select>
	
	<!-- 根据vipId查询VIP规则 -->
	<select id="getVipProductById" parameterType="Long" resultMap="vipProductResultMap">
		<![CDATA[
		SELECT id,vip_id,create_time,client_id,client_name,activities_name,vip_price,status,count,remark  
		FROM cb_vip_product WHERE id = #{vipId} AND status <>'3' LIMIT 1
		]]> 
	</select>
	
	<!-- 删除绑定关系的中间表 -->
	<delete id="deleteProductFromVip" parameterType="java.util.HashMap">
		DELETE  
		FROM cb_vip_bind_product
		WHERE vip_id=#{vipId} AND product_id = #{productId}
	</delete>
	
</mapper>

