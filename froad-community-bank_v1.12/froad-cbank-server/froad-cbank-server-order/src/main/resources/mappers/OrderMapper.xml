<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.OrderMapper">

	<resultMap type="Product" id="productResultMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="merchantId" column="merchant_id" />
		<result property="orgCode" column="org_code" />
		<result property="productId" column="product_id" />
		<result property="isMarketable" column="is_marketable" />
		<result property="rackTime" column="rack_time" />
		<result property="downTime" column="down_time" />
		<result property="createTime" column="create_time" />
		<result property="type" column="type" />
		<result property="deliverOption" column="deliver_option" />
		<result property="name" column="name" />
		<result property="fullName" column="full_name" />
		<result property="price" column="price" />
		<result property="cost" column="cost" />
		<result property="marketPrice" column="market_price" />
		<result property="weight" column="weight" />
		<result property="weightUnit" column="weight_unit" />
		<result property="store" column="store" />
		<result property="freezeStore" column="freeze_store" />
		<result property="isBest" column="is_best" />
		<result property="isLimit" column="is_limit" />
		<result property="point" column="point" />
		<result property="briefIntroduction" column="brief_introduction" />
		<result property="introduction" column="introduction" />
		<result property="buyKnow" column="buy_know" />
		<result property="auditState" column="audit_state" />
		<result property="auditOrgCode" column="audit_org_code" />
		<result property="needReview" column="need_review" />
		<result property="auditStage" column="audit_stage" />
		<result property="reviewStaff" column="review_staff" />
		<result property="auditStaff" column="audit_staff" />
		<result property="orderValue" column="order_value" />
		<result property="storeCount" column="store_count" />
		<result property="sellCount" column="sell_count" />
	</resultMap>
	
	<resultMap type="ProductSeckill" id="productSeckillResultMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="merchantid" column="merchant_id" />
		<result property="createTime" column="create_time" />
		<result property="productId" column="product_id" />
		<result property="type" column="type" />
		<result property="secStore" column="sec_store" />
		<result property="secPrice" column="sec_price" />
		<result property="vipSecPrice" column="vip_sec_price" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="trueBuyerNumber" column="true_buyer_number" />
		<result property="buyLimit" column="buy_limit" />
		<result property="isMarketable" column="is_marketable" />
		<result property="auditState" column="audit_state" />
		<result property="auditOrgCode" column="audit_org_code" />
		<result property="auditStage" column="audit_stage" />
		<result property="reviewStaff" column="review_staff" />
		<result property="auditStaff" column="audit_staff" />
		<result property="type" column="type" />
		<result property="name" column="name" />
		<result property="price" column="price" />
		<result property="marketPrice" column="market_price" />
		<result property="deliveryStartTime" column="delivery_start_time" />
		<result property="deliveryEndTime" column="delivery_end_time" />
		<result property="briefIntroduction" column="brief_introduction" />
		<result property="phone" column="phone" />
		<result property="deliveryOption" column="delivery_option" />
		<result property="buyKnow" column="buy_know" />
		<result property="introduction" column="introduction" />
	</resultMap>
	
	<resultMap type="ProductMonthCount" id="productMonthCountResultMap">
		<id property="id" column="id" />
		<result property="clientId"        column="client_id" />
		<result property="merchantId"      column="merchant_id" />
		<result property="productId"       column="product_id" />
		<result property="year"            column="year" />
		<result property="month"           column="month" />
		<result property="sellCount"       column="sell_count" />
	</resultMap>
	
	<resultMap type="PresellShip" id="presellShippingReportMap">
		<id property="id" column="id" />
		<result property="clientId" column="client_id" />
		<result property="orderId" column="order_id" />
		<result property="subOrderId" column="sub_order_id" />
		<result property="orderTime" column="order_time" />
		<result property="receiveName" column="receive_name" />
		<result property="productName" column="product_name" />
		<result property="phone" column="phone" />
		<result property="receiveAddress" column="receive_address" />
		<result property="fOrg" column="f_org" />
		<result property="fOrgName" column="f_org_name" />
		<result property="sOrg" column="s_org" />
		<result property="sOrgName" column="s_org_name" />
		<result property="productId" column="product_id" />
		<result property="presellStartTime" column="presell_start_time" />
		<result property="presellEndTime" column="presell_end_time" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="buyNumber" column="buy_number" />
		<result property="refundNumber" column="refund_number" />
	</resultMap>
	
	<!-- 商户用户表 -->
	<resultMap type="java.util.HashMap" id="merchantUserResultMap">
		<id property="id" column="id" />
		<result property="username" column="username" />
	</resultMap>
	
	<!-- 地区表 -->
	<resultMap type="java.util.HashMap" id="areaNameResultMap">
		<id property="id" column="id" />
		<result property="name" column="tree_path_name" />
	</resultMap>
	
	
	<!-- 批量修改库存  Product -->
	<update id="updateProductStoreByBatch" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
			update cb_product set store = #{item.store}
				<where>
						client_id = #{item.clientId}
					and merchant_id = #{item.merchantId}
					and product_id = #{item.productId}
				</where>
		</foreach>
	</update>
	
	<!-- 修改库存  Product -->
	<update id="updateProductStore" parameterType="Product" >
		update cb_product set store = #{store}
		where product_id = #{productId}
			<!-- and client_id = #{clientId} -->
	</update>
	
	<!-- 修改销售数量  Product -->
	<update id="updateProductSellCount" parameterType="Product" >
		update cb_product set sell_count = IFNULL(sell_count,0)+#{sellCount}
		where product_id = #{productId}
			<!-- and client_id = #{clientId} -->
	</update>
	
	<!-- 获取销售数量  Product -->
	<select id="getProductSellCount" resultType="Integer">
		select sell_count from cb_product
		where product_id = #{productId}
			<!-- and client_id = #{clientId} -->
	</select>
	
	<insert id="insertProductMonthCount" parameterType="Product" >
		insert into cb_product_month_count (client_id, merchant_id,product_id, year, month,sell_count,sell_money)
		select &apos;${clientId}&apos;,&apos;${merchantId}&apos;,&apos;${productId}&apos;,${year},&apos;${month}&apos;,0,0 from dual where not exists(select id from cb_product_month_count where product_id=#{productId} and merchant_id=#{merchantId} and client_id=#{clientId} and year=#{year} and month=#{month})
	</insert>

	<update id="updateProductMonthCount" parameterType="ProductMonthCount" >
		update cb_product_month_count
		set
		sell_count = sell_count + ${sellCount},
		sell_money = sell_money + ${sellMoney}
		where product_id=#{productId} and merchant_id=#{merchantId} and client_id=#{clientId} and year=#{year} and month=#{month}
	</update>
	
	<!-- 修改秒杀商品库存数量  ProductSeckill -->
	<update id="updateSeckillProductStore" parameterType="ProductSeckill" >
		update cb_product_seckill set sec_store = #{secStore}
		where  product_id = #{productId}
			<!-- client_id = #{clientId}
			and (merchant_id = #{merchantId} or org_code = #{merchantId}) -->
	</update>
	
	<!-- 修改秒杀商品销售数量  ProductSeckill -->
	<update id="updateSeckillProductSellCount" parameterType="ProductSeckill" >
		update cb_product_seckill set true_buyer_number = IFNULL(true_buyer_number,0) + #{trueBuyerNumber}
		where  product_id = #{productId}
			<!-- client_id = #{clientId}
			and (merchant_id = #{merchantId} or org_code = #{merchantId}) -->
	</update>
	
	<!-- 查询  Outlet -->
	<select id="getOutletNameByOutletId" resultType="String">
		SELECT 
            outlet_name
        FROM cb_outlet 
        WHERE 
            outlet_id = #{outletId}
            and merchant_id = #{merchantId}
            and client_id = #{clientId}

	</select>
	
		
	<!-- 查询  预售订单商品发货信息 -->
	<select id="queryPresellShipByPage" parameterType="java.util.HashMap" resultMap="presellShippingReportMap">
		SELECT id,client_id,order_id,sub_order_id,order_time,product_name,receive_name,phone,receive_address,f_org,f_org_name,s_org,s_org_name,product_id,presell_start_time,presell_end_time,start_time,end_time,buy_number,refund_number
        FROM cb_presell_shipping_report
        <where> 
                1 = 1
                <if test="p.clientId != null">
		 			AND client_id = #{p.clientId}
				</if>
                
				<if test="p.presellStartTime != null">
		 			AND presell_start_time <![CDATA[>=]]> #{p.presellStartTime}
				</if>
				
				<if test="p.presellEndTime != null">
		 			AND presell_end_time <![CDATA[<=]]> #{p.presellEndTime}
				</if>	
				
				<if test="p.startTime != null">
			 		AND order_time <![CDATA[>=]]> #{p.startTime}
				</if>
				
				<if test="p.endTime != null">
			 		AND order_time <![CDATA[<=]]> #{p.endTime}
				</if>		
				
				<if test="p.fOrg != null">
		 			AND f_org = #{p.fOrg}
				</if>		
				
				<if test="p.sOrg != null">
		 			AND s_org = #{p.sOrg}
				</if>	
		</where>
	</select>
	
	<!-- 查询  MerchantUserName -->
	<select id="findMerchantUserNameByIdList" parameterType="java.util.List" resultMap="merchantUserResultMap">
		SELECT u.id,u.username
        FROM cb_merchant_user u
        WHERE u.id in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
					#{id}
		</foreach>
	</select>
	
	<!-- 查询  MerchantUserName -->
	<select id="findMerchantUserNameById" parameterType="java.lang.Long" resultType="java.lang.String">
		SELECT u.username
        FROM cb_merchant_user u
        WHERE u.id = #{id}
	</select>
	
		
	<!-- 查询  areaId -->
	<select id="findAreaNameById" parameterType="java.util.List" resultMap="areaNameResultMap">
		SELECT u.id,u.tree_path_name
        FROM cb_area u
        WHERE u.id in
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
					#{id}
		</foreach>
	</select>
	
</mapper>