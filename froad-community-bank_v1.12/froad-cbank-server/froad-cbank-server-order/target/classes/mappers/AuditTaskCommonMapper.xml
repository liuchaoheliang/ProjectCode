<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.mapper.AuditTaskCommonMapper">

	<resultMap type="AuditTask" id="auditTaskCommonResultMap">
		<id property="id" column="id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="thridId" column="thrid_id" />
		<result property="userName" column="user_name" />
		<result property="auditId" column="audit_id" />
		<result property="orgCode" column="org_code" />
		<result property="orgName" column="org_name" />
		<result property="type" column="type" />
		<result property="name" column="name" />
		<result property="busCode" column="bus_code" />
		<result property="auditStartOrgCode" column="audit_start_org_code" />
		<result property="auditEndOrgCode" column="audit_end_org_code" />
		<result property="auditOrgCode" column="audit_org_code" />
		<result property="auditState" column="audit_state" />
		<result property="state" column="state" />
		<result property="auditTime" column="audit_time" />
		
	</resultMap>
	
	
	<!-- 添加  AuditTask -->
	<insert id="addAuditTask" parameterType="AuditTask" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			INSERT INTO cb_audit_task (
				create_time,client_id,thrid_id,user_name,audit_id,org_code,org_name,type,name,bus_code,audit_start_org_code,audit_end_org_code,audit_org_code,audit_state,state,audit_time
			) VALUES (
				#{createTime},#{clientId},#{thridId},#{userName},#{auditId},#{orgCode},#{orgName},#{type},#{name},#{busCode},#{auditStartOrgCode},#{auditEndOrgCode},#{auditOrgCode},#{auditState},#{state},#{auditTime}
			) 
		]]>
	</insert>
	


	<!-- 根据商户id获得商户审核任务订单信息 -->
	<select id="findAuditTaskByMerchantId" parameterType="java.lang.String" resultMap="auditTaskCommonResultMap">
		select 
			id,create_time,client_id,thrid_id,user_name,audit_id,org_code,org_name,type,name,bus_code,audit_start_org_code,audit_end_org_code,audit_org_code,audit_state,state,audit_time      
		from cb_audit_task 
			where thrid_id=#{thridId}  and state=0 and audit_state=0  
	</select>
	
	
	<!-- 根据商户id获得商户审核任务订单信息 -->
	<select id="findAuditTaskByAuditId" parameterType="java.lang.String" resultMap="auditTaskCommonResultMap">
		select 
			id,create_time,client_id,thrid_id,user_name,audit_id,org_code,org_name,type,name,bus_code,audit_start_org_code,audit_end_org_code,audit_org_code,audit_state,state,audit_time      
		from cb_audit_task 
			where audit_id=#{auditId} 
	</select>
	
	
	<!-- 修改审核任务订单信息 -->
	<update id="updateAuditTask" parameterType="AuditTask">
		update cb_audit_task 
		<set>
			<if test="auditTime != null">
				 audit_time = #{auditTime},
			</if>
			<if test="auditState != null">
				 audit_state = #{auditState}, 
			</if>
			<if test="state != null">
				 state = #{state},   
			</if>
			<if test="auditOrgCode != null">
				 audit_org_code = #{auditOrgCode},   
			</if>
		</set>
		where thrid_id=#{thridId}  and state=0 and audit_state=0  
	</update>
	

	<!-- 分页查询 审核任务订单表  AuditTask -->
	<select id="findAuditTaskByPage" parameterType="java.util.HashMap" resultMap="auditTaskCommonResultMap">
		select 
			cr.id,cr.create_time,cr.client_id,cr.thrid_id,cr.user_name,cr.audit_id,cr.org_code,cr.org_name,cr.type,cr.name,cr.bus_code,cr.audit_start_org_code,cr.audit_end_org_code,cr.audit_org_code,cr.audit_state,cr.state,cr.audit_time      
		from cb_audit_task cr 
		<if test="auditTask != null">
			<if test="auditTask.orgCode != null">
				<if test="flag==2"><!-- 2-查当前机构所有下属机构 -->
					inner join (select org_code from cb_org where (province_agency=#{auditTask.orgCode} 
		 			or city_agency=#{auditTask.orgCode}  
		 			or county_agency=#{auditTask.orgCode}  
		 			or org_code=#{auditTask.orgCode} )
		 			AND client_id = #{auditTask.clientId} and is_enable=true )  co  
					on  cr.org_code=co.org_code  
				</if>
			</if>
			<where>
				<if test="flag==1"><!-- 1-查当前机构 -->
					AND cr.org_code=#{auditTask.orgCode} 
				</if>
				<if test="auditTask.startCreateTime != null">
					 AND cr.create_time <![CDATA[ >= ]]> #{auditTask.startCreateTime}
				</if>
				<if test="auditTask.endCreateTime != null">				
					 AND cr.create_time <![CDATA[ <= ]]> #{auditTask.endCreateTime}
				</if>
				<if test="auditTask.startAuditTime != null">
					 AND cr.audit_time <![CDATA[ >= ]]> #{auditTask.startAuditTime}
				</if>
				<if test="auditTask.endAuditTime != null">				
					 AND cr.audit_time <![CDATA[ <= ]]> #{auditTask.endAuditTime}
				</if>
				
				<if test="auditTask.auditId != null">
					 AND cr.audit_id = #{auditTask.auditId}
				</if>
				<if test="auditTask.type != null">
					 AND cr.type = #{auditTask.type}
				</if>
				<if test="auditTask.name != null">
					 AND cr.name like CONCAT('%',#{auditTask.name},'%' )  
				</if>
				<if test="auditTask.busCode != null">
					 AND cr.bus_code = #{auditTask.busCode}
				</if>
				<if test="auditTask.state != null">
					 AND cr.state = #{auditTask.state}
				</if>
				<if test="auditTask.clientId != null">
					 AND cr.client_id = #{auditTask.clientId}
				</if>
			</where>
		</if>
		<if test="flag==1 or (flag==2 and auditTask.state==0)" >
			 order by cr.create_time desc   
		</if>
		<if test="flag==2 and auditTask.state==1" >
			 order by cr.audit_time desc   
		</if>
		
	</select>
	
	
	
	
	
</mapper>

