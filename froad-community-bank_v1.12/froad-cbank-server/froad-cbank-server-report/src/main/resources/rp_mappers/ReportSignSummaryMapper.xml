<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.db.mysql.rp_mappers.ReportSignSummaryMapper">
	<resultMap type="ReportSignSummary" id="reportSignSummaryResultMap">
		<id property="id" column="id" />
		<result property="createTime" column="create_time" />
		<result property="clientId" column="client_id" />
		<result property="forgCode" column="forg_code" />
		<result property="forgName" column="forg_name" />
		<result property="sorgCode" column="sorg_code" />
		<result property="sorgName" column="sorg_name" />
		<result property="torgCode" column="torg_code" />
		<result property="torgName" column="torg_name" />
		<result property="lorgCode" column="lorg_code" />
		<result property="lorgName" column="lorg_name" />
		<result property="signUserName" column="sign_user_name" />
		<result property="totalMerchants" column="total_merchants" />
	</resultMap>
	
	<sql id="selectColumn">
		id,create_time,client_id,forg_code,forg_name,sorg_code,sorg_name,torg_code,torg_name,
		lorg_code,lorg_name,sign_user_name,total_merchants 
	</sql>
	
	
	<insert id="addByBatch">
		INSERT INTO cb_report_sign_summary(
			create_time,client_id,forg_code,forg_name,sorg_code,sorg_name,torg_code,torg_name,
			lorg_code,lorg_name,sign_user_name,total_merchants
		) VALUES 
		<foreach collection="summarys" item="item" index="index" separator=",">
			(#{item.createTime},#{item.clientId},#{item.forgCode},#{item.forgName},
			#{item.sorgCode},#{item.sorgName},#{item.torgCode},#{item.torgName},
			#{item.lorgCode},#{item.lorgName},#{item.signUserName},#{item.totalMerchants})
		</foreach>
	</insert>
	
	
	<select id="findByDate" resultMap="reportSignSummaryResultMap">
		SELECT <include refid="selectColumn" /> 
		FROM cb_report_sign_summary 
		<where>
			<if test="startDate != null">
				AND create_time >= #{startDate}
			</if>
			<if test="endDate != null">
				<![CDATA[
				AND create_time <= #{endDate}
				]]>
			</if>
		</where>
	</select>
	
	<select id="findSummaryMaxDate" resultType="java.util.Date">
		SELECT MAX(create_time) create_time FROM cb_report_sign_summary
	</select>
	
	<select id="getTotalMechantsBySignUser" resultMap="reportSignSummaryResultMap">
		SELECT 
			sign_user_name,SUM(total_merchants) total_merchants
		FROM 
			cb_report_sign_summary 
		<where>
			<if test="begDate != null">
				AND create_time >= #{begDate} 
			</if>
			<if test="endDate != null">
			<![CDATA[
				AND create_time <= #{endDate} 
			]]>
			</if>
			<if test="user.clientId != null">
				AND client_id = #{user.clientId}
			</if>
			<if test="user.forgCode != null and flag == false">
				AND forg_code = #{user.forgCode} 
			</if>
			<if test="user.forgCode != null and flag == true">
				AND forg_code = #{user.forgCode} 
				AND (sorg_code IS NULL OR sorg_code = '') 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.sorgCode != null and flag == false">
				AND sorg_code = #{user.sorgCode} 
			</if>
			<if test="user.sorgCode != null and flag == true">
				AND sorg_code = #{user.sorgCode} 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.torgCode != null and flag == false">
				AND torg_code = #{user.torgCode} 
			</if>
			<if test="user.torgCode != null and flag == true">
				AND torg_code = #{user.torgCode} 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.lorgCode != null">
				AND lorg_code = #{user.lorgCode} 
			</if>
		</where>
		GROUP BY 
			sign_user_name 
	</select>
	
	
	<select id="selectContractRank" resultMap="reportSignSummaryResultMap">
		SELECT 
			sign_user_name,SUM(total_merchants) total_merchants
		FROM 
			cb_report_sign_summary 
		<where>
			<if test="begDate != null">
				AND create_time >= #{begDate} 
			</if>
			<if test="endDate != null">
			<![CDATA[
				AND create_time <= #{endDate} 
			]]>
			</if>
			<if test="user.clientId != null">
				AND client_id = #{user.clientId}
			</if>
			<if test="user.forgCode != null and flag == false">
				AND forg_code = #{user.forgCode} 
			</if>
			<if test="user.forgCode != null and flag == true">
				AND forg_code = #{user.forgCode} 
				AND (sorg_code IS NULL OR sorg_code = '') 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.sorgCode != null and flag == false">
				AND sorg_code = #{user.sorgCode} 
			</if>
			<if test="user.sorgCode != null and flag == true">
				AND sorg_code = #{user.sorgCode} 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.torgCode != null and flag == false">
				AND torg_code = #{user.torgCode} 
			</if>
			<if test="user.torgCode != null and flag == true">
				AND torg_code = #{user.torgCode} 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.lorgCode != null">
				AND lorg_code = #{user.lorgCode} 
			</if>
			AND sign_user_name != '' 
			AND sign_user_name IS NOT NULL 
			AND !(sign_user_name LIKE '%系统%') 
		</where>
		GROUP BY 
			sign_user_name 
		ORDER BY 
			total_merchants DESC,sign_user_name 
		LIMIT 
			10
	</select>
	
	
	<select id="selectTotalMerchantsByOrg" resultType="java.lang.Integer">
		SELECT SUM(total_merchants) 
		FROM 
			cb_report_sign_summary 
		<where>
			<if test="begDate != null">
				AND create_time >= #{begDate} 
			</if>
			<if test="endDate != null">
			<![CDATA[
				AND create_time <= #{endDate} 
			]]>
			</if>
			<if test="user.clientId != null">
				AND client_id = #{user.clientId}
			</if>
			<if test="user.forgCode != null and flag == false">
				AND forg_code=#{user.forgCode} 
			</if>
			<if test="user.forgCode != null and flag == true">
				AND forg_code=#{user.forgCode} 
				AND (sorg_code IS NULL OR sorg_code = '') 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.sorgCode != null and flag == false">
				AND sorg_code=#{user.sorgCode} 
			</if>
			<if test="user.sorgCode != null and flag == true">
				AND sorg_code=#{user.sorgCode} 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.torgCode != null and flag == false">
				AND torg_code=#{user.torgCode} 
			</if>
			<if test="user.torgCode != null and flag == true">
				AND torg_code=#{user.torgCode} 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.lorgCode != null">
				AND lorg_code=#{user.lorgCode} 
			</if>
		</where>
		GROUP BY 
		<if test="user.forgCode != null">
			forg_code 
		</if>
		<if test="user.sorgCode != null">
			sorg_code 
		</if>
		<if test="user.torgCode != null">
			torg_code 
		</if>
		<if test="user.lorgCode != null">
			lorg_code 
		</if>
	</select>
	
	<select id="getTotalMerchantsByOrg" resultMap="reportSignSummaryResultMap">
		SELECT client_id,forg_code,forg_name,sorg_code,sorg_name,torg_code,torg_name,lorg_code,lorg_name,SUM(total_merchants) total_merchants 
		FROM cb_report_sign_summary 
		<where>
			<if test="begDate != null">
				AND create_time >= #{begDate} 
			</if>
			<if test="endDate != null">
			<![CDATA[
				AND create_time <= #{endDate} 
			]]>
			</if>
			<if test="user.clientId != null">
				AND client_id = #{user.clientId}
			</if>
			<if test="user.forgCode != null and flag == false">
				AND forg_code = #{user.forgCode} 
			</if>
			<if test="user.forgCode != null and flag == true">
				AND forg_code = #{user.forgCode} 
				AND (sorg_code IS NULL OR sorg_code = '') 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.sorgCode != null and flag == false">
				AND sorg_code = #{user.sorgCode} 
			</if>
			<if test="user.sorgCode != null and flag == true">
				AND sorg_code = #{user.sorgCode} 
				AND (torg_code IS NULL OR torg_code = '') 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.torgCode != null and flag == false">
				AND torg_code = #{user.torgCode} 
			</if>
			<if test="user.torgCode != null and flag == true">
				AND torg_code = #{user.torgCode} 
				AND (lorg_code IS NULL OR lorg_code = '') 
			</if>
			<if test="user.lorgCode != null">
				AND lorg_code = #{user.lorgCode} 
			</if>
		</where>
		GROUP BY 
			client_id,forg_code,sorg_code,torg_code,lorg_code 
	</select>
	
	
</mapper>